// Dashboard JavaScript
// Translation dictionary
const translations = {
    en: {
        site_name: '',
        dashboard_title: 'Documentation Dashboard',
        site_description: '',
        libraries: 'Libraries',
        total_keywords: 'Total Keywords',
        search_keywords: 'Search keywords...',
        search_libraries: 'Search libraries...',
        no_libraries_found: 'No libraries found.',
        available_libraries: 'Available Libraries',
        sort_by: 'Sort by:',
        sort_name_asc: 'Name (A–Z)',
        sort_keywords_desc: 'Keyword count (desc)',
        export_as: 'Export as',
        filters: 'Filters',
        clear_all: 'Clear All',
        author: 'Author:',
        maintainer: 'Maintainer:',
        license: 'License:',
        rf_version: 'RF Version:',
        python: 'Python:',
        version: 'Version',
        all_authors: 'All Authors',
        all_maintainers: 'All Maintainers',
        all_licenses: 'All Licenses',
        all_versions: 'All Versions',
        generated_by: 'Generated by',
        last_updated: 'Last updated',
        keyword: 'keyword',
        keywords: 'keywords'
    },
    es: {
        site_name: '',
        dashboard_title: 'Panel de Documentación',
        site_description: '',
        libraries: 'Bibliotecas',
        total_keywords: 'Palabras Clave Totales',
        search_keywords: 'Buscar palabras clave...',
        search_libraries: 'Buscar bibliotecas...',
        no_libraries_found: 'No se encontraron bibliotecas.',
        available_libraries: 'Bibliotecas Disponibles',
        sort_by: 'Ordenar por:',
        sort_name_asc: 'Nombre (A–Z)',
        sort_keywords_desc: 'Cantidad de palabras clave (desc)',
        export_as: 'Exportar como',
        filters: 'Filtros',
        clear_all: 'Limpiar Todo',
        author: 'Autor:',
        maintainer: 'Mantenedor:',
        license: 'Licencia:',
        rf_version: 'Versión RF:',
        python: 'Python:',
        version: 'Versión',
        all_authors: 'Todos los Autores',
        all_maintainers: 'Todos los Mantenedores',
        all_licenses: 'Todas las Licencias',
        all_versions: 'Todas las Versiones',
        generated_by: 'Generado por',
        last_updated: 'Última actualización',
        keyword: 'palabra clave',
        keywords: 'palabras clave'
    },
    fr: {
        site_name: '',
        dashboard_title: 'Tableau de Bord de Documentation',
        site_description: '',
        libraries: 'Bibliothèques',
        total_keywords: 'Mots-clés Totaux',
        search_keywords: 'Rechercher des mots-clés...',
        search_libraries: 'Rechercher des bibliothèques...',
        no_libraries_found: 'Aucune bibliothèque trouvée.',
        available_libraries: 'Bibliothèques Disponibles',
        sort_by: 'Trier par:',
        sort_name_asc: 'Nom (A–Z)',
        sort_keywords_desc: 'Nombre de mots-clés (desc)',
        export_as: 'Exporter comme',
        filters: 'Filtres',
        clear_all: 'Tout Effacer',
        author: 'Auteur:',
        maintainer: 'Mainteneur:',
        license: 'Licence:',
        rf_version: 'Version RF:',
        python: 'Python:',
        version: 'Version',
        all_authors: 'Tous les Auteurs',
        all_maintainers: 'Tous les Mainteneurs',
        all_licenses: 'Toutes les Licences',
        all_versions: 'Toutes les Versions',
        generated_by: 'Généré par',
        last_updated: 'Dernière mise à jour',
        keyword: 'mot-clé',
        keywords: 'mots-clés'
    },
    de: {
        site_name: '',
        dashboard_title: 'Dokumentations-Dashboard',
        site_description: '',
        libraries: 'Bibliotheken',
        total_keywords: 'Gesamt-Schlüsselwörter',
        search_keywords: 'Schlüsselwörter suchen...',
        search_libraries: 'Bibliotheken suchen...',
        no_libraries_found: 'Keine Bibliotheken gefunden.',
        available_libraries: 'Verfügbare Bibliotheken',
        sort_by: 'Sortieren nach:',
        sort_name_asc: 'Name (A–Z)',
        sort_keywords_desc: 'Schlüsselwortanzahl (abst)',
        export_as: 'Exportieren als',
        filters: 'Filter',
        clear_all: 'Alle Löschen',
        author: 'Autor:',
        maintainer: 'Wartung:',
        license: 'Lizenz:',
        rf_version: 'RF-Version:',
        python: 'Python:',
        version: 'Version',
        all_authors: 'Alle Autoren',
        all_maintainers: 'Alle Wartungen',
        all_licenses: 'Alle Lizenzen',
        all_versions: 'Alle Versionen',
        generated_by: 'Erstellt von',
        last_updated: 'Zuletzt aktualisiert',
        keyword: 'Schlüsselwort',
        keywords: 'Schlüsselwörter'
    },
    zh: {
        site_name: '',
        dashboard_title: '文档仪表板',
        site_description: '',
        libraries: '库',
        total_keywords: '总关键字',
        search_keywords: '搜索关键字...',
        search_libraries: '搜索库...',
        no_libraries_found: '未找到库。',
        available_libraries: '可用库',
        sort_by: '排序方式:',
        sort_name_asc: '名称 (A–Z)',
        sort_keywords_desc: '关键字数量 (降序)',
        export_as: '导出为',
        filters: '筛选器',
        clear_all: '清除全部',
        author: '作者:',
        maintainer: '维护者:',
        license: '许可证:',
        rf_version: 'RF 版本:',
        python: 'Python:',
        version: '版本',
        all_authors: '所有作者',
        all_maintainers: '所有维护者',
        all_licenses: '所有许可证',
        all_versions: '所有版本',
        generated_by: '由生成',
        last_updated: '最后更新',
        keyword: '关键字',
        keywords: '关键字'
    },
    ja: {
        site_name: '',
        dashboard_title: 'ドキュメントダッシュボード',
        site_description: '',
        libraries: 'ライブラリ',
        total_keywords: '総キーワード数',
        search_keywords: 'キーワードを検索...',
        search_libraries: 'ライブラリを検索...',
        no_libraries_found: 'ライブラリが見つかりません。',
        available_libraries: '利用可能なライブラリ',
        sort_by: '並び替え:',
        sort_name_asc: '名前 (A–Z)',
        sort_keywords_desc: 'キーワード数 (降順)',
        export_as: 'エクスポート',
        filters: 'フィルター',
        clear_all: 'すべてクリア',
        author: '作成者:',
        maintainer: 'メンテナー:',
        license: 'ライセンス:',
        rf_version: 'RF バージョン:',
        python: 'Python:',
        version: 'バージョン',
        all_authors: 'すべての作成者',
        all_maintainers: 'すべてのメンテナー',
        all_licenses: 'すべてのライセンス',
        all_versions: 'すべてのバージョン',
        generated_by: '生成元',
        last_updated: '最終更新',
        keyword: 'キーワード',
        keywords: 'キーワード'
    },
    pt: {
        site_name: '',
        dashboard_title: 'Painel de Documentação',
        site_description: '',
        libraries: 'Bibliotecas',
        total_keywords: 'Total de Palavras-chave',
        search_keywords: 'Pesquisar palavras-chave...',
        search_libraries: 'Pesquisar bibliotecas...',
        no_libraries_found: 'Nenhuma biblioteca encontrada.',
        available_libraries: 'Bibliotecas Disponíveis',
        sort_by: 'Ordenar por:',
        sort_name_asc: 'Nome (A–Z)',
        sort_keywords_desc: 'Contagem de palavras-chave (desc)',
        export_as: 'Exportar como',
        filters: 'Filtros',
        clear_all: 'Limpar Tudo',
        author: 'Autor:',
        maintainer: 'Mantenedor:',
        license: 'Licença:',
        rf_version: 'Versão RF:',
        python: 'Python:',
        version: 'Versão',
        all_authors: 'Todos os Autores',
        all_maintainers: 'Todos os Mantenedores',
        all_licenses: 'Todas as Licenças',
        all_versions: 'Todas as Versões',
        generated_by: 'Gerado por',
        last_updated: 'Última atualização',
        keyword: 'palavra-chave',
        keywords: 'palavras-chave'
    },
    ru: {
        site_name: '',
        dashboard_title: 'Панель Документации',
        site_description: '',
        libraries: 'Библиотеки',
        total_keywords: 'Всего Ключевых Слов',
        search_keywords: 'Поиск ключевых слов...',
        search_libraries: 'Поиск библиотек...',
        no_libraries_found: 'Библиотеки не найдены.',
        available_libraries: 'Доступные Библиотеки',
        sort_by: 'Сортировать по:',
        sort_name_asc: 'Имя (А–Я)',
        sort_keywords_desc: 'Количество ключевых слов (убыв)',
        export_as: 'Экспортировать как',
        filters: 'Фильтры',
        clear_all: 'Очистить Все',
        author: 'Автор:',
        maintainer: 'Сопровождающий:',
        license: 'Лицензия:',
        rf_version: 'Версия RF:',
        python: 'Python:',
        version: 'Версия',
        all_authors: 'Все Авторы',
        all_maintainers: 'Все Сопровождающие',
        all_licenses: 'Все Лицензии',
        all_versions: 'Все Версии',
        generated_by: 'Создано',
        last_updated: 'Последнее обновление',
        keyword: 'ключевое слово',
        keywords: 'ключевые слова'
    },
    it: {
        site_name: '',
        dashboard_title: 'Dashboard Documentazione',
        site_description: '',
        libraries: 'Librerie',
        total_keywords: 'Parole Chiave Totali',
        search_keywords: 'Cerca parole chiave...',
        search_libraries: 'Cerca librerie...',
        no_libraries_found: 'Nessuna libreria trovata.',
        available_libraries: 'Librerie Disponibili',
        sort_by: 'Ordina per:',
        sort_name_asc: 'Nome (A–Z)',
        sort_keywords_desc: 'Conteggio parole chiave (disc)',
        export_as: 'Esporta come',
        filters: 'Filtri',
        clear_all: 'Cancella Tutto',
        author: 'Autore:',
        maintainer: 'Manutentore:',
        license: 'Licenza:',
        rf_version: 'Versione RF:',
        python: 'Python:',
        version: 'Versione',
        all_authors: 'Tutti gli Autori',
        all_maintainers: 'Tutti i Manutentori',
        all_licenses: 'Tutte le Licenze',
        all_versions: 'Tutte le Versioni',
        generated_by: 'Generato da',
        last_updated: 'Ultimo aggiornamento',
        keyword: 'parola chiave',
        keywords: 'parole chiave'
    },
    ko: {
        site_name: '',
        dashboard_title: '문서 대시보드',
        site_description: '',
        libraries: '라이브러리',
        total_keywords: '총 키워드',
        search_keywords: '키워드 검색...',
        search_libraries: '라이브러리 검색...',
        no_libraries_found: '라이브러리를 찾을 수 없습니다.',
        available_libraries: '사용 가능한 라이브러리',
        sort_by: '정렬 기준:',
        sort_name_asc: '이름 (A–Z)',
        sort_keywords_desc: '키워드 수 (내림차순)',
        export_as: '내보내기',
        filters: '필터',
        clear_all: '모두 지우기',
        author: '작성자:',
        maintainer: '유지보수자:',
        license: '라이선스:',
        rf_version: 'RF 버전:',
        python: 'Python:',
        version: '버전',
        all_authors: '모든 작성자',
        all_maintainers: '모든 유지보수자',
        all_licenses: '모든 라이선스',
        all_versions: '모든 버전',
        generated_by: '생성자',
        last_updated: '마지막 업데이트',
        keyword: '키워드',
        keywords: '키워드'
    }
};

// Translation function
function translatePage(lang) {
    const t = translations[lang] || translations.en;
    
    // Translate elements with data-i18n attribute (skip if translation is empty)
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key] !== undefined && t[key] !== '') {
            el.textContent = t[key];
        }
    });
    
    // Translate placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (t[key] !== undefined && t[key] !== '') {
            el.placeholder = t[key];
        }
    });
    
    // Translate option elements
    document.querySelectorAll('option[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key] !== undefined && t[key] !== '') {
            el.textContent = t[key];
        }
    });
    
    // Translate keyword count in library stats
    document.querySelectorAll('[data-i18n-keyword-count]').forEach(el => {
        const count = parseInt(el.getAttribute('data-i18n-keyword-count'), 10);
        const keywordText = count === 1 ? t.keyword : t.keywords;
        el.textContent = `${count} ${keywordText}`;
    });
    
    // Store language preference
    localStorage.setItem('dashboard_language', lang);
}

// Initialize language on page load
document.addEventListener('DOMContentLoaded', function() {
    // Restore language preference or default to English
    const savedLang = localStorage.getItem('dashboard_language') || 'en';
    const langSelector = document.getElementById('language-selector');
    if (langSelector) {
        langSelector.value = savedLang;
        translatePage(savedLang);
        
        // Listen for language changes
        langSelector.addEventListener('change', function(e) {
            translatePage(e.target.value);
        });
    }
    
    // Initialize library search functionality (filters library cards)
    const searchInput = document.getElementById('global-search');
    const noResults = document.getElementById('no-results');
    const librariesGrid = document.getElementById('libraries-grid');
    let libraryCards = librariesGrid ? Array.from(librariesGrid.querySelectorAll('.library-card')) : [];
    
    // Sort libraries function
    function sortLibraries(sortBy) {
        if (!librariesGrid || libraryCards.length === 0) return;
        
        libraryCards.sort((a, b) => {
            if (sortBy === 'name-asc') {
                const nameA = a.getAttribute('data-library-name') || '';
                const nameB = b.getAttribute('data-library-name') || '';
                return nameA.localeCompare(nameB);
            } else if (sortBy === 'keywords-desc') {
                const countA = parseInt(a.getAttribute('data-keyword-count') || '0', 10);
                const countB = parseInt(b.getAttribute('data-keyword-count') || '0', 10);
                return countB - countA; // Descending order
            }
            return 0;
        });
        
        // Re-append sorted cards
        libraryCards.forEach(card => {
            librariesGrid.appendChild(card);
        });
    }
    
    // Initialize sort dropdown
    const sortSelect = document.getElementById('library-sort');
    if (sortSelect) {
        // Restore last sort preference from localStorage
        const savedSort = localStorage.getItem('dashboard_sort');
        if (savedSort) {
            sortSelect.value = savedSort;
        }
        
        sortSelect.addEventListener('change', function(e) {
            const sortValue = e.target.value;
            sortLibraries(sortValue);
            // Save to localStorage
            localStorage.setItem('dashboard_sort', sortValue);
        });
        
        // Initial sort (use saved preference or default to name A-Z)
        sortLibraries(sortSelect.value);
    }
    
    // Filter libraries function
    function filterLibraries() {
        if (!librariesGrid || libraryCards.length === 0) return;
        
        // Get filter values
        const filterAuthor = (document.getElementById('filter-author')?.value || '').toLowerCase();
        const filterMaintainer = (document.getElementById('filter-maintainer')?.value || '').toLowerCase();
        const filterLicense = (document.getElementById('filter-license')?.value || '').toLowerCase();
        const filterRobotFramework = (document.getElementById('filter-robot-framework')?.value || '').toLowerCase();
        const filterPython = (document.getElementById('filter-python')?.value || '').toLowerCase();
        
        // Check if any filters are active
        const hasActiveFilters = filterAuthor || filterMaintainer || filterLicense || filterRobotFramework || filterPython;
        const clearBtn = document.getElementById('clear-filters');
        if (clearBtn) {
            clearBtn.style.display = hasActiveFilters ? 'block' : 'none';
        }
        
        // Get search query
        const searchQuery = searchInput ? searchInput.value.trim().toLowerCase() : '';
        
        // Filter library cards
        let visibleCount = 0;
        libraryCards.forEach(card => {
            // Check search match
            let matchesSearch = true;
            if (searchQuery.length > 0) {
                const libraryName = card.getAttribute('data-library-name') || '';
                const libraryDescription = card.getAttribute('data-library-description') || '';
                matchesSearch = libraryName.includes(searchQuery) || libraryDescription.includes(searchQuery);
            }
            
            // Check filter matches
            const cardAuthor = (card.getAttribute('data-author') || '').toLowerCase();
            const cardMaintainer = (card.getAttribute('data-maintainer') || '').toLowerCase();
            const cardLicense = (card.getAttribute('data-license') || '').toLowerCase();
            const cardRobotFramework = (card.getAttribute('data-robot-framework') || '').toLowerCase();
            const cardPython = (card.getAttribute('data-python') || '').toLowerCase();
            
            const matchesAuthor = !filterAuthor || cardAuthor === filterAuthor;
            const matchesMaintainer = !filterMaintainer || cardMaintainer === filterMaintainer;
            const matchesLicense = !filterLicense || cardLicense === filterLicense;
            const matchesRobotFramework = !filterRobotFramework || cardRobotFramework === filterRobotFramework;
            const matchesPython = !filterPython || cardPython === filterPython;
            
            // Show card if it matches all criteria
            if (matchesSearch && matchesAuthor && matchesMaintainer && matchesLicense && matchesRobotFramework && matchesPython) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        if (visibleCount === 0) {
            noResults.classList.add('active');
        } else {
            noResults.classList.remove('active');
        }
    }
    
    // Initialize filters
    const filterSelects = ['filter-author', 'filter-maintainer', 'filter-license', 'filter-robot-framework', 'filter-python'];
    filterSelects.forEach(filterId => {
        const filterSelect = document.getElementById(filterId);
        if (filterSelect) {
            // Restore saved filter from localStorage
            const savedFilter = localStorage.getItem(`dashboard_filter_${filterId}`);
            if (savedFilter) {
                filterSelect.value = savedFilter;
            }
            
            filterSelect.addEventListener('change', function(e) {
                const filterValue = e.target.value;
                // Save to localStorage
                if (filterValue) {
                    localStorage.setItem(`dashboard_filter_${filterId}`, filterValue);
                } else {
                    localStorage.removeItem(`dashboard_filter_${filterId}`);
                }
                filterLibraries();
            });
        }
    });
    
    // Clear filters button
    const clearFiltersBtn = document.getElementById('clear-filters');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            filterSelects.forEach(filterId => {
                const filterSelect = document.getElementById(filterId);
                if (filterSelect) {
                    filterSelect.value = '';
                    localStorage.removeItem(`dashboard_filter_${filterId}`);
                }
            });
            clearFiltersBtn.style.display = 'none';
            filterLibraries();
        });
    }
    
    // Build filters container HTML
    function buildFiltersContainer() {
        if (!window.filterData) return '';
        
        const filterData = window.filterData;
        const buildFilterHTML = (label, filterId, options) => {
            if (!options || options.length === 0) return '';
            const allLabel = label.includes('Version') ? 'All Versions' : `All ${label}s`;
            const optionsHTML = options.map(opt => 
                `<option value="${opt.toLowerCase()}">${opt}</option>`
            ).join('');
            return `
                <div class="filter-group">
                    <label for="${filterId}" class="filter-label">${label}</label>
                    <select id="${filterId}" class="filter-select">
                        <option value="">${allLabel}</option>
                        ${optionsHTML}
                    </select>
                </div>
            `;
        };
        
        return `
            <div class="filters-container">
                <div class="filters-header">
                    <button id="clear-filters" class="clear-filters-btn" style="display: none;" data-i18n="clear_all">Clear All</button>
                </div>
                <div class="filters-grid">
                    ${buildFilterHTML('Author', 'filter-author', filterData.authors)}
                    ${buildFilterHTML('Maintainer', 'filter-maintainer', filterData.maintainers)}
                    ${buildFilterHTML('License', 'filter-license', filterData.licenses)}
                    ${buildFilterHTML('RF Version', 'filter-robot-framework', filterData.robotFrameworks)}
                    ${buildFilterHTML('Python', 'filter-python', filterData.pythons)}
                </div>
            </div>
        `;
    }
    
    // Build export container HTML
    function buildExportContainer() {
        return `
            <div class="export-container">
                <div class="export-options">
                    <button class="export-option-btn" data-export="csv">CSV</button>
                    <button class="export-option-btn" data-export="excel">Excel</button>
                    <button class="export-option-btn" data-export="pdf">PDF</button>
                </div>
            </div>
        `;
    }
    
    // Initialize filter functionality
    function initializeFilters(filtersContainer) {
        const filterSelects = ['filter-author', 'filter-maintainer', 'filter-license', 'filter-robot-framework', 'filter-python'];
        filterSelects.forEach(filterId => {
            const filterSelect = document.getElementById(filterId);
            if (filterSelect) {
                const savedFilter = localStorage.getItem(`dashboard_filter_${filterId}`);
                if (savedFilter) {
                    filterSelect.value = savedFilter;
                }
                filterSelect.addEventListener('change', function(e) {
                    const filterValue = e.target.value;
                    if (filterValue) {
                        localStorage.setItem(`dashboard_filter_${filterId}`, filterValue);
                    } else {
                        localStorage.removeItem(`dashboard_filter_${filterId}`);
                    }
                    filterLibraries();
                });
            }
        });
        
        // Clear filters button
        const clearFiltersBtn = document.getElementById('clear-filters');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function() {
                filterSelects.forEach(filterId => {
                    const select = document.getElementById(filterId);
                    if (select) {
                        select.value = '';
                        localStorage.removeItem(`dashboard_filter_${filterId}`);
                    }
                });
                filterLibraries();
                clearFiltersBtn.style.display = 'none';
            });
        }
        
        // Check if any filters are active
        function updateClearFiltersButton() {
            if (clearFiltersBtn) {
                const hasActiveFilters = filterSelects.some(filterId => {
                    const select = document.getElementById(filterId);
                    return select && select.value;
                });
                clearFiltersBtn.style.display = hasActiveFilters ? 'block' : 'none';
            }
        }
        
        // Update clear button on filter change
        filterSelects.forEach(filterId => {
            const filterSelect = document.getElementById(filterId);
            if (filterSelect) {
                filterSelect.addEventListener('change', updateClearFiltersButton);
            }
        });
        updateClearFiltersButton();
    }
    
    // Initialize filters toggle
    const filtersToggleBtn = document.getElementById('filters-toggle-btn');
    let filtersContainer = null;
    
    if (filtersToggleBtn) {
        filtersToggleBtn.addEventListener('click', function() {
            const librariesSection = document.querySelector('.libraries-section');
            if (!librariesSection) return;
            
            if (!filtersContainer) {
                // Create and inject filters container
                const filtersHTML = buildFiltersContainer();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = filtersHTML;
                filtersContainer = tempDiv.firstElementChild;
                librariesSection.insertBefore(filtersContainer, document.getElementById('libraries-grid'));
                
                // Initialize filter functionality
                initializeFilters(filtersContainer);
                
                // Show container (it's already visible since we don't add collapsed class)
                filtersToggleBtn.classList.add('active');
            } else {
                // Remove container from DOM
                filtersContainer.remove();
                filtersContainer = null;
                filtersToggleBtn.classList.remove('active');
            }
        });
    }
    
    // Initial filter application
    filterLibraries();
    
    // Export functionality
    function exportToCSV() {
        const visibleCards = libraryCards.filter(card => card.style.display !== 'none');
        if (visibleCards.length === 0) {
            alert('No libraries to export');
            return;
        }
        
        const csvRows = ['Library Name,Version,Keywords,Author,Maintainer,License,RF Version,Python,Description'];
        
        visibleCards.forEach(card => {
            const name = card.querySelector('h2 a')?.textContent || '';
            const version = card.querySelector('.badge')?.textContent.replace('Version: ', '') || '';
            const keywords = card.getAttribute('data-keyword-count') || '0';
            const author = card.getAttribute('data-author') || '';
            const maintainer = card.getAttribute('data-maintainer') || '';
            const license = card.getAttribute('data-license') || '';
            const rfVersion = card.getAttribute('data-robot-framework') || '';
            const python = card.getAttribute('data-python') || '';
            // Get description from data attribute first, fallback to element text
            const description = card.getAttribute('data-description-text') || card.querySelector('.library-description')?.textContent?.trim() || '';
            
            // Escape CSV values
            const escapeCSV = (val) => {
                if (!val) return '';
                const str = String(val);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };
            
            csvRows.push([
                escapeCSV(name),
                escapeCSV(version),
                escapeCSV(keywords),
                escapeCSV(author),
                escapeCSV(maintainer),
                escapeCSV(license),
                escapeCSV(rfVersion),
                escapeCSV(python),
                escapeCSV(description)
            ].join(','));
        });
        
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'libraries-export.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function exportToExcel() {
        const visibleCards = libraryCards.filter(card => card.style.display !== 'none');
        if (visibleCards.length === 0) {
            alert('No libraries to export');
            return;
        }
        
        // Generate Excel-compatible CSV with UTF-8 BOM for proper Excel opening
        const csvRows = ['Library Name,Version,Keywords,Author,Maintainer,License,RF Version,Python,Description'];
        
        visibleCards.forEach(card => {
            const name = card.querySelector('h2 a')?.textContent || '';
            const version = card.querySelector('.badge')?.textContent.replace('Version: ', '') || '';
            const keywords = card.getAttribute('data-keyword-count') || '0';
            const author = card.getAttribute('data-author') || '';
            const maintainer = card.getAttribute('data-maintainer') || '';
            const license = card.getAttribute('data-license') || '';
            const rfVersion = card.getAttribute('data-robot-framework') || '';
            const python = card.getAttribute('data-python') || '';
            // Get description from data attribute first, fallback to element text
            const description = card.getAttribute('data-description-text') || card.querySelector('.library-description')?.textContent?.trim() || '';
            
            const escapeCSV = (val) => {
                if (!val) return '';
                const str = String(val);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };
            
            csvRows.push([
                escapeCSV(name),
                escapeCSV(version),
                escapeCSV(keywords),
                escapeCSV(author),
                escapeCSV(maintainer),
                escapeCSV(license),
                escapeCSV(rfVersion),
                escapeCSV(python),
                escapeCSV(description)
            ].join(','));
        });
        
        // Add UTF-8 BOM for Excel compatibility
        const csvContent = '\ufeff' + csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'libraries-export.xlsx');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function exportToPDF() {
        const visibleCards = libraryCards.filter(card => card.style.display !== 'none');
        if (visibleCards.length === 0) {
            alert('No libraries to export');
            return;
        }
        
        // Create a print-friendly version
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            alert('Please allow popups to export as PDF');
            return;
        }
        
        const siteName = document.querySelector('.dashboard-header h2')?.textContent || 'Documentation Dashboard';
        const exportDate = new Date().toLocaleString();
        
        let htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Libraries Export - ${siteName}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        padding: 20px;
                        color: #333;
                    }
                    h1 {
                        color: #38bdf8;
                        border-bottom: 2px solid #38bdf8;
                        padding-bottom: 10px;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 20px;
                    }
                    th, td {
                        border: 1px solid #ddd;
                        padding: 12px;
                        text-align: left;
                    }
                    th {
                        background-color: #38bdf8;
                        color: white;
                        font-weight: bold;
                    }
                    tr:nth-child(even) {
                        background-color: #f9f9f9;
                    }
                    .meta {
                        color: #666;
                        font-size: 0.9em;
                        margin-bottom: 20px;
                    }
                </style>
            </head>
            <body>
                <h1>${siteName}</h1>
                <div class="meta">Exported: ${exportDate} | Total Libraries: ${visibleCards.length}</div>
                <table>
                    <thead>
                        <tr>
                            <th>Library Name</th>
                            <th>Version</th>
                            <th>Keywords</th>
                            <th>Author</th>
                            <th>Maintainer</th>
                            <th>License</th>
                            <th>RF Version</th>
                            <th>Python</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        visibleCards.forEach(card => {
            const name = card.querySelector('h2 a')?.textContent || '';
            const version = card.querySelector('.badge')?.textContent.replace('Version: ', '') || '';
            const keywords = card.getAttribute('data-keyword-count') || '0';
            const author = card.getAttribute('data-author') || '';
            const maintainer = card.getAttribute('data-maintainer') || '';
            const license = card.getAttribute('data-license') || '';
            const rfVersion = card.getAttribute('data-robot-framework') || '';
            const python = card.getAttribute('data-python') || '';
            // Get description from data attribute first, fallback to element text
            const description = card.getAttribute('data-description-text') || card.querySelector('.library-description')?.textContent?.trim() || '';
            
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            htmlContent += `
                <tr>
                    <td>${escapeHtml(name)}</td>
                    <td>${escapeHtml(version)}</td>
                    <td>${escapeHtml(keywords)}</td>
                    <td>${escapeHtml(author)}</td>
                    <td>${escapeHtml(maintainer)}</td>
                    <td>${escapeHtml(license)}</td>
                    <td>${escapeHtml(rfVersion)}</td>
                    <td>${escapeHtml(python)}</td>
                    <td>${escapeHtml(description)}</td>
                </tr>
            `;
        });
        
        htmlContent += `
                    </tbody>
                </table>
            </body>
            </html>
        `;
        
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        
        // Wait for content to load, then trigger print
        setTimeout(() => {
            printWindow.print();
        }, 250);
    }
    
    // Export dropdown functionality
    // Export select functionality
    // Export toggle functionality
    const exportToggleBtn = document.getElementById('export-toggle-btn');
    let exportContainer = null;
    
    if (exportToggleBtn) {
        exportToggleBtn.addEventListener('click', function() {
            const librariesSection = document.querySelector('.libraries-section');
            if (!librariesSection) return;
            
            if (!exportContainer) {
                // Create and inject export container
                const exportHTML = buildExportContainer();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = exportHTML;
                exportContainer = tempDiv.firstElementChild;
                librariesSection.insertBefore(exportContainer, document.getElementById('libraries-grid'));
                
                // Initialize export button handlers
                const exportOptionBtns = exportContainer.querySelectorAll('.export-option-btn');
                exportOptionBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const format = this.getAttribute('data-export');
                        
                        if (format === 'csv') {
                            exportToCSV();
                        } else if (format === 'excel') {
                            exportToExcel();
                        } else if (format === 'pdf') {
                            exportToPDF();
                        }
                    });
                });
                
                // Show container (it's already visible since we don't add collapsed class)
                exportToggleBtn.classList.add('active');
            } else {
                // Remove container from DOM
                exportContainer.remove();
                exportContainer = null;
                exportToggleBtn.classList.remove('active');
            }
        });
    }
    
    if (searchInput) {
        // Restore last search query from localStorage
        const savedSearch = localStorage.getItem('dashboard_search');
        if (savedSearch) {
            searchInput.value = savedSearch;
            // Trigger search to show results
            const event = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(event);
        }
        
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim().toLowerCase();
            
            // Save search query to localStorage
            if (query.length > 0) {
                localStorage.setItem('dashboard_search', query);
            } else {
                localStorage.removeItem('dashboard_search');
            }
            
            // Re-get cards after sorting (in case DOM changed)
            libraryCards = librariesGrid ? Array.from(librariesGrid.querySelectorAll('.library-card')) : [];
            
            // Apply filters (which includes search)
            filterLibraries();
        });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Initialize keyword search in header
    const keywordSearchInput = document.getElementById('keyword-search');
    const keywordSearchResults = document.getElementById('keyword-search-results');
    
    // Track keyboard navigation state
    let selectedResultIndex = -1;
    let currentResults = [];
    
    if (keywordSearchInput) {
        let searchTimeout;
        
        // Restore last keyword search from localStorage
        const savedKeywordSearch = localStorage.getItem('dashboard_keyword_search');
        if (savedKeywordSearch) {
            keywordSearchInput.value = savedKeywordSearch;
            // Trigger search to show results
            const event = new Event('input', { bubbles: true });
            keywordSearchInput.dispatchEvent(event);
        }
        
        keywordSearchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim().toLowerCase();
            
            // Save keyword search to localStorage
            if (query.length > 0) {
                localStorage.setItem('dashboard_keyword_search', query);
            } else {
                localStorage.removeItem('dashboard_keyword_search');
            }
            
            clearTimeout(searchTimeout);
            
            if (query.length === 0) {
                keywordSearchResults.classList.remove('active');
                keywordSearchResults.innerHTML = '';
                selectedResultIndex = -1;
                currentResults = [];
                return;
            }
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                // Load and search index for keywords only
                fetch('assets/search-index.json')
                    .then(response => response.json())
                    .then(index => {
                        // Only search keywords
                        const results = index.filter(item => {
                            if (item.type === 'keyword') {
                                return item.keyword.toLowerCase().includes(query);
                            }
                            return false;
                        }).slice(0, 10); // Limit to 10 results for dropdown
                        
                        currentResults = results;
                        selectedResultIndex = -1; // Reset selection
                        displayKeywordResults(results);
                    })
                    .catch(error => {
                        console.error('Error loading search index:', error);
                        keywordSearchResults.classList.add('active');
                        keywordSearchResults.innerHTML = '<div style="padding: 1.5rem 1rem; color: #ef4444; text-align: center; font-size: 0.9rem;">Error loading search index</div>';
                        currentResults = [];
                        selectedResultIndex = -1;
                    });
            }, 200);
        });
        
        // Keyboard navigation for search input
        keywordSearchInput.addEventListener('keydown', function(e) {
            if (!keywordSearchResults.classList.contains('active') || currentResults.length === 0) {
                return;
            }
            
            const resultItems = keywordSearchResults.querySelectorAll('.search-result-item');
            
            // Arrow down - move to next result
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedResultIndex = (selectedResultIndex + 1) % resultItems.length;
                updateHighlight(resultItems);
                scrollToHighlighted(resultItems[selectedResultIndex]);
            }
            
            // Arrow up - move to previous result
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (selectedResultIndex <= 0) {
                    selectedResultIndex = resultItems.length - 1;
                } else {
                    selectedResultIndex--;
                }
                updateHighlight(resultItems);
                scrollToHighlighted(resultItems[selectedResultIndex]);
            }
            
            // Enter - open selected result
            if (e.key === 'Enter' && selectedResultIndex >= 0) {
                e.preventDefault();
                const selectedItem = resultItems[selectedResultIndex];
                const link = selectedItem.querySelector('a');
                if (link) {
                    window.location.href = link.href;
                }
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!keywordSearchInput.contains(e.target) && !keywordSearchResults.contains(e.target)) {
                keywordSearchResults.classList.remove('active');
                selectedResultIndex = -1;
            }
        });
        
        // Global keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Press '/' to focus keyword search (only if not already typing in an input)
            if (e.key === '/' && !e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey) {
                const activeElement = document.activeElement;
                const isInputFocused = activeElement && (
                    activeElement.tagName === 'INPUT' || 
                    activeElement.tagName === 'TEXTAREA' || 
                    activeElement.isContentEditable
                );
                
                // Only focus if not already typing in an input
                if (!isInputFocused) {
                    e.preventDefault();
                    keywordSearchInput.focus();
                    keywordSearchInput.select();
                }
            }
            
            // Press 'Escape' to close dropdown and blur search
            if (e.key === 'Escape') {
                // Close dropdown if open
                if (keywordSearchResults.classList.contains('active')) {
                    keywordSearchResults.classList.remove('active');
                    keywordSearchResults.innerHTML = '';
                    selectedResultIndex = -1;
                    currentResults = [];
                }
                // Always blur search input if it's focused
                if (document.activeElement === keywordSearchInput) {
                    keywordSearchInput.blur();
                }
            }
        });
        
        function updateHighlight(resultItems) {
            resultItems.forEach((item, index) => {
                if (index === selectedResultIndex) {
                    item.classList.add('highlighted');
                } else {
                    item.classList.remove('highlighted');
                }
            });
        }
        
        function scrollToHighlighted(element) {
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
    }
    
    function displayKeywordResults(results) {
        if (results.length === 0) {
            keywordSearchResults.classList.add('active');
            keywordSearchResults.innerHTML = '<div style="padding: 1.5rem 1rem; color: var(--muted); text-align: center; font-size: 0.9rem; font-style: italic;">No keywords found</div>';
            selectedResultIndex = -1;
            return;
        }
        
        keywordSearchResults.classList.add('active');
        keywordSearchResults.innerHTML = results.map(item => `
            <div class="search-result-item">
                <a href="${item.url}" class="result-title">${escapeHtml(item.keyword)}</a>
                <div class="library-name">${escapeHtml(item.library)}</div>
            </div>
        `).join('');
        
        // Reset selection when new results are displayed
        selectedResultIndex = -1;
    }
});
